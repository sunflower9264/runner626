<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runner626 - Phaseråœ°å›¾æ¸²æŸ“å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }
        
        h1 {
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 12px;
            font-weight: bold;
            color: #667eea;
        }
        
        select, button {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        select {
            background: white;
        }
        
        button {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .info {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #333;
        }
        
        #game-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .legend {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-width: 800px;
        }
        
        .legend h3 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #999;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>ğŸ® Runner626 - Phaseråœ°å›¾æ¸²æŸ“å™¨</h1>
    
    <div class="controls">
        <div class="control-group">
            <label>å…³å¡é€‰æ‹©</label>
            <select id="level-select">
                <option value="0">Level 0</option>
                <option value="1">Level 1</option>
                <option value="2">Level 2</option>
                <option value="3">Level 3</option>
                <option value="4">Level 4</option>
                <option value="5">Level 5</option>
                <option value="6">Level 6</option>
                <option value="7">Level 7</option>
                <option value="8">Level 8</option>
                <option value="9">Level 9</option>
                <option value="10">Level 10</option>
                <option value="11">Level 11</option>
                <option value="12">Level 12</option>
                <option value="13">Level 13</option>
                <option value="14">Level 14</option>
                <option value="15">Level 15</option>
            </select>
        </div>
        
        <button id="reload-btn">ğŸ”„ é‡æ–°åŠ è½½</button>
        <button id="zoom-in">ğŸ”+ æ”¾å¤§</button>
        <button id="zoom-out">ğŸ”- ç¼©å°</button>
        <button id="editor-btn" onclick="window.location.href='map_editor.html'">âœï¸ æ‰“å¼€ç¼–è¾‘å™¨</button>
    </div>
    
    <div class="info" id="info">
        åŠ è½½ä¸­...
    </div>
    
    <div id="game-container"></div>
    
    <div class="legend">
        <h3>ğŸ¨ åœ°å½¢é¢œè‰²å›¾ä¾‹ (Tileå€¼=Spriteç´¢å¼•)</h3>
        <div class="legend-grid">
            <div class="legend-item">
                <div class="legend-color" style="background: #8B4513"></div>
                <span>ä¸»åœ°å½¢ (42)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #A0522D"></div>
                <span>åœ°å½¢å˜ä½“ (1-6)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #654321"></div>
                <span>å¹³å°è¾¹ç¼˜ (23,41)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #696969"></div>
                <span>é‡‘å±å¹³å° (7-11)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9370DB"></div>
                <span>åˆ‡æ¢å¹³å° (12,18)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF0000"></div>
                <span>å°–åˆºé™·é˜± (35,39,48,131)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #CD853F"></div>
                <span>å¯ç ´åç‰© (89,102,132)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #C0C0C0"></div>
                <span>è£…é¥°ç‰© (95ç­‰)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF0000; border-radius: 50%"></div>
                <span>æ•Œäºº</span>
            </div>
        </div>
    </div>

    <script type="module">
        // Tileå€¼å°±æ˜¯spriteå›¾ç‰‡ç´¢å¼•
        // ä¸åŒèŒƒå›´çš„å€¼è¡¨ç¤ºç¿»è½¬å˜ä½“:
        // å‡è®¾spriteæ•°é‡ä¸ºNï¼Œåˆ™:
        //   0 ~ N-1: åŸå§‹sprite
        //   N ~ 2N-1: æ°´å¹³ç¿»è½¬
        //   2N ~ 3N-1: å‚ç›´ç¿»è½¬
        // 
        // ç¢°æ’åˆ¤æ–­åœ¨c.javaä¸­æ˜¯å¦å¤–çš„å‡½æ•°å¤„ç†çš„
        // è¿™é‡Œæˆ‘ä»¬åªæ ¹æ®tileå€¼åˆ†é…å¯è§†åŒ–é¢œè‰²
        
        // æ ¹æ®tileå€¼è·å–é¢œè‰² - ç®€å•çš„åˆ†ç»„ç€è‰²
        function getTileColor(tile) {
            if (tile === 0) return null; // ç©ºæ°”ï¼Œé€æ˜
            
            // æœ€å¸¸è§çš„åœ°å½¢å— 42 - ä¸»åœ°å½¢æ£•è‰²
            if (tile === 42) return 0x8B4513;
            
            // 1-6: åŸºç¡€åœ°å½¢å˜ä½“ - æ£•è‰²ç³»
            if (tile >= 1 && tile <= 6) return 0xA0522D;
            
            // 7-11: é‡‘å±/ç‰¹æ®Šå¹³å° - ç°è‰²
            if (tile >= 7 && tile <= 11) return 0x696969;
            
            // 12, 18: åˆ‡æ¢å¹³å° - ç´«è‰²
            if (tile === 12 || tile === 18) return 0x9370DB;
            
            // 13-17, 19-22: å¹³å°å…ƒç´  - æ·±ç°
            if (tile >= 13 && tile <= 22) return 0x505050;
            
            // 23: å¹³å°è¾¹ç¼˜ - æ·±æ£•
            if (tile === 23) return 0x654321;
            
            // 24-27: è£…é¥° - æµ…ç°
            if (tile >= 24 && tile <= 27) return 0xA9A9A9;
            
            // 28-32: å®ä½“å— - æ·±æ£•
            if (tile >= 28 && tile <= 32) return 0x5C4033;
            
            // 33-40: åœ°å½¢å˜ä½“ - æ£•è‰²
            if (tile >= 33 && tile <= 40) return 0x8B5A2B;
            
            // 41: å¹³å° - æ·±æ£•è¾¹ç¼˜
            if (tile === 41) return 0x6B4423;
            
            // 43-50: ç‰¹æ®Šåœ°å½¢ - æ·±æ£•
            if (tile >= 43 && tile <= 50) return 0x7B5427;
            
            // 35, 39, 48, 50, 131: å°–åˆºé™·é˜± - çº¢è‰²
            if (tile === 35 || tile === 39 || tile === 48 || tile === 131) return 0xFF0000;
            
            // 51-70: åœ°å½¢/è£…é¥° - æµ…æ£•
            if (tile >= 51 && tile <= 70) return 0x9B7B5B;
            
            // 71-90: åœ°å½¢ - ä¸­æ£•
            if (tile >= 71 && tile <= 90) return 0x8B6B4B;
            
            // 89, 102, 132: å¯ç ´å - æ©™æ£•
            if (tile === 89 || tile === 102 || tile === 132) return 0xCD853F;
            
            // 91-110: åœ°å½¢ - æ£•è‰²
            if (tile >= 91 && tile <= 110) return 0x7B5B3B;
            
            // 95: è£…é¥° - æµ…ç°
            if (tile === 95) return 0xC0C0C0;
            
            // 111-150: è¾ƒé«˜ç´¢å¼•åœ°å½¢ - æµ…æ£•
            if (tile >= 111 && tile <= 150) return 0xAB8B6B;
            
            // 150+: é«˜ç´¢å¼•sprite(å¯èƒ½æ˜¯ç¿»è½¬ç‰ˆ) - ä¸­æ£•
            if (tile > 150) return 0x9B7B5B;
            
            // é»˜è®¤ç°è‰²
            return 0x808080;
        }

        class MapScene extends Phaser.Scene {
            constructor() {
                super({ key: 'MapScene' });
                this.stageData = null;
                this.levelConfig = null;
                this.currentLevel = 0;
                this.tileSize = 8;
                this.zoomLevel = 1;
            }

            preload() {
                // é¢„åŠ è½½æ•°æ®
                this.load.json('levelConfig', '../map_data/level_config.json');
                
                for (let i = 0; i < 5; i++) {
                    this.load.json(`stage${i}`, `../map_data/stage${i}.json`);
                }
                
                // é¢„åŠ è½½plano1 sprites (åœ°å½¢)
                // plano1æœ‰55ä¸ªspriteï¼Œtileå€¼0-54æ˜¯åŸå§‹ï¼Œ55-108æ˜¯æ°´å¹³ç¿»è½¬ï¼Œ109-162æ˜¯å‚ç›´ç¿»è½¬
                for (let i = 0; i < 55; i++) {
                    this.load.image(`tile_${i}`, `sprites/plano1/sprite_${i.toString().padStart(3, '0')}.png`);
                }
            }

            create() {
                this.levelConfig = this.cache.json.get('levelConfig');
                this.cameras.main.setBackgroundColor('#87CEEB'); // å¤©ç©ºè“
                
                // åˆå§‹åŠ è½½
                this.loadLevel(0);
                
                // è®¾ç½®ç›¸æœºæ§åˆ¶
                this.cameras.main.setZoom(this.zoomLevel);
                
                // æ·»åŠ æ‹–æ‹½æ§åˆ¶ - ç›´æ¥é¼ æ ‡æ‹–æ‹½
                this.input.on('pointermove', (pointer) => {
                    if (pointer.isDown) {
                        this.cameras.main.scrollX -= (pointer.x - pointer.prevPosition.x) / this.zoomLevel;
                        this.cameras.main.scrollY -= (pointer.y - pointer.prevPosition.y) / this.zoomLevel;
                    }
                });
                
                // æ»šè½®ç¼©æ”¾
                this.input.on('wheel', (pointer, gameObjects, deltaX, deltaY) => {
                    if (deltaY > 0) {
                        this.zoomLevel = Math.max(0.25, this.zoomLevel - 0.1);
                    } else {
                        this.zoomLevel = Math.min(3, this.zoomLevel + 0.1);
                    }
                    this.cameras.main.setZoom(this.zoomLevel);
                });
            }

            loadLevel(levelIndex) {
                this.currentLevel = levelIndex;
                
                // æ¸…é™¤æ—§å†…å®¹
                this.children.removeAll();
                
                // è·å–å—åºåˆ—
                const sequence = this.levelConfig.chunkSequences[levelIndex];
                
                // ç¡®å®šä½¿ç”¨å“ªä¸ªstage
                let stageIndex = Math.floor(levelIndex / 3);
                if (stageIndex > 4) stageIndex = 4;
                
                const stageName = `stage${stageIndex}`;
                this.stageData = this.cache.json.get(stageName);
                
                if (!this.stageData) {
                    console.error('Stage data not found:', stageName);
                    return;
                }
                
                const chunkWidth = this.stageData.metadata.chunkWidth;
                const chunkHeight = this.stageData.metadata.chunkHeight;
                
                let xOffset = 0;
                
                // æ¸²æŸ“æ¯ä¸ªå—
                sequence.forEach(chunkId => {
                    const chunk = this.stageData.chunks[chunkId];
                    if (chunk) {
                        this.renderChunk(chunk, xOffset, 0);
                        xOffset += chunkWidth * this.tileSize;
                    }
                });
                
                // æ›´æ–°ä¿¡æ¯
                this.updateInfo(sequence, xOffset);
                
                // é‡ç½®ç›¸æœºä½ç½®
                this.cameras.main.scrollX = 0;
                this.cameras.main.scrollY = 0;
            }

            renderChunk(chunk, offsetX, offsetY) {
                const terrain = chunk.terrain;
                const chunkHeight = terrain.length;
                const chunkWidth = terrain[0].length;
                
                // plano1æœ‰55ä¸ªspriteï¼Œtileå€¼æ˜ å°„:
                // 0-54: åŸå§‹sprite
                // 55-108: æ°´å¹³ç¿»è½¬ (sprite = tile - 55)
                // 109-162: å‚ç›´ç¿»è½¬ (sprite = tile - 109)
                const NUM_SPRITES = 55;
                
                // æ¸²æŸ“åœ°å½¢
                for (let y = 0; y < chunkHeight; y++) {
                    for (let x = 0; x < chunkWidth; x++) {
                        const tileValue = terrain[y][x];
                        if (tileValue === 0) continue; // è·³è¿‡ç©ºæ°”
                        
                        const px = offsetX + x * this.tileSize;
                        const py = offsetY + y * this.tileSize;
                        
                        // è®¡ç®—spriteç´¢å¼•å’Œç¿»è½¬
                        let spriteIndex = tileValue;
                        let flipX = false;
                        let flipY = false;
                        
                        if (tileValue >= NUM_SPRITES * 2) {
                            // å‚ç›´ç¿»è½¬
                            spriteIndex = tileValue - NUM_SPRITES * 2;
                            flipY = true;
                        } else if (tileValue >= NUM_SPRITES) {
                            // æ°´å¹³ç¿»è½¬
                            spriteIndex = tileValue - NUM_SPRITES;
                            flipX = true;
                        }
                        
                        // å°è¯•ä½¿ç”¨spriteå›¾ç‰‡
                        const textureKey = `tile_${spriteIndex}`;
                        if (this.textures.exists(textureKey)) {
                            const sprite = this.add.image(px, py, textureKey);
                            sprite.setOrigin(0, 0);
                            sprite.setFlipX(flipX);
                            sprite.setFlipY(flipY);
                            // ç¼©æ”¾åˆ°tileSize (spriteåŸå§‹å¤§å°å¯èƒ½ä¸æ˜¯8x8)
                            sprite.setDisplaySize(this.tileSize, this.tileSize);
                        } else {
                            // å›é€€åˆ°é¢œè‰²æ–¹å—
                            const color = getTileColor(tileValue);
                            if (color !== null) {
                                const tile = this.add.rectangle(px, py, this.tileSize, this.tileSize, color);
                                tile.setOrigin(0, 0);
                                tile.setStrokeStyle(0.5, 0x000000, 0.3);
                            }
                        }
                    }
                }
                
                // æ¸²æŸ“æ•Œäºº
                chunk.enemies.forEach(enemy => {
                    const px = offsetX + enemy.x * this.tileSize + this.tileSize / 2;
                    const py = offsetY + enemy.y * this.tileSize + this.tileSize / 2;
                    
                    const circle = this.add.circle(px, py, this.tileSize / 2, 0xFF0000);
                    circle.setStrokeStyle(1, 0x800000);
                    
                    const text = this.add.text(px, py, 'E', {
                        fontSize: `${this.tileSize - 2}px`,
                        color: '#FFFFFF',
                        fontStyle: 'bold'
                    });
                    text.setOrigin(0.5, 0.5);
                });
                
                // æ¸²æŸ“éšœç¢ç‰©
                chunk.obstacles.forEach(obstacle => {
                    const px = offsetX + obstacle.x * this.tileSize;
                    const py = offsetY + obstacle.y * this.tileSize;
                    
                    const rect = this.add.rectangle(
                        px, py,
                        this.tileSize, this.tileSize,
                        0x800080, 0.8
                    );
                    rect.setOrigin(0, 0);
                    rect.setStrokeStyle(1, 0x400040);
                });
                
                // æ¸²æŸ“æ”¶é›†å“
                chunk.collectibles.forEach(collectible => {
                    const px = offsetX + collectible.x * this.tileSize + this.tileSize / 2;
                    const py = offsetY + collectible.y * this.tileSize + this.tileSize / 2;
                    
                    const circle = this.add.circle(px, py, this.tileSize / 3, 0xFFD700);
                    circle.setStrokeStyle(1, 0xFFA500);
                });
            }

            updateInfo(sequence, totalWidth) {
                const info = document.getElementById('info');
                info.innerHTML = `
                    <strong>å…³å¡ ${this.currentLevel}</strong> |
                    å—åºåˆ—: [${sequence.join(', ')}] |
                    å®½åº¦: ${totalWidth}px (${totalWidth / this.tileSize} tiles) |
                    é«˜åº¦: 240px (30 tiles) |
                    ç¼©æ”¾: ${(this.zoomLevel * 100).toFixed(0)}%
                `;
            }
        }

        // Phaseré…ç½®
        const config = {
            type: Phaser.AUTO,
            width: 1200,
            height: 300,
            parent: 'game-container',
            backgroundColor: '#87CEEB',
            scene: MapScene,
            pixelArt: true,
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false
                }
            }
        };

        const game = new Phaser.Game(config);
        
        // ç­‰å¾…åœºæ™¯åˆ›å»ºå®Œæˆåå†è®¾ç½®UIæ§åˆ¶
        game.events.once('ready', () => {
            const scene = game.scene.scenes[0];

            // UIæ§åˆ¶
            document.getElementById('level-select').addEventListener('change', (e) => {
                scene.loadLevel(parseInt(e.target.value));
            });

            document.getElementById('reload-btn').addEventListener('click', () => {
                scene.loadLevel(scene.currentLevel);
            });

            document.getElementById('zoom-in').addEventListener('click', () => {
                scene.zoomLevel = Math.min(3, scene.zoomLevel + 0.25);
                scene.cameras.main.setZoom(scene.zoomLevel);
                scene.updateInfo(scene.levelConfig.chunkSequences[scene.currentLevel], 0);
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                scene.zoomLevel = Math.max(0.25, scene.zoomLevel - 0.25);
                scene.cameras.main.setZoom(scene.zoomLevel);
                scene.updateInfo(scene.levelConfig.chunkSequences[scene.currentLevel], 0);
            });
        });
    </script>
</body>
</html>
